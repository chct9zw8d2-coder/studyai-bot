def detect_lang(user_language_code: str | None, message_text: str | None) -> str:
    if user_language_code:
        lc = user_language_code.lower()
        if lc.startswith(("ru","uk","be","kk")):
            return "ru"
    if message_text:
        for ch in message_text:
            if "–ê" <= ch <= "—è" or ch in "—ë–Å—ñ–Ü—ó–á—î–Ñ":
                return "ru"
    return "en"

T = {
  "ru": {
    "welcome_title": "üéì StudyAI ‚Äî –ø–æ–º–æ—â–Ω–∏–∫ –¥–ª—è —É—á—ë–±—ã –∏ –∫—Ä–µ–∞—Ç–∏–≤–∞",
    "welcome_body": "–í—ã–±–µ—Ä–∏ —Ä–µ–∂–∏–º –Ω–∏–∂–µ.\\n\\nüí° –†–µ—Ñ–µ—Ä–∞–ª–∫–∞: –ü—Ä–æ—Ñ–∏–ª—å ‚Üí –†–µ—Ñ–µ—Ä–∞–ª–∫–∞.",
    "menu_study": "üìö –ü–æ–º–æ—â—å –≤ —É—á—ë–±–µ / –î–ó",
    "menu_grade": "‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏ –æ—Ü–µ–Ω–∫–∞",
    "menu_ege": "üìù –û–ì–≠ / –ï–ì–≠",
    "menu_chill": "üé≤ –û—Ç–≤–ª–µ—á—å—Å—è",
    "menu_sub": "‚≠ê –ü–æ–¥–ø–∏—Å–∫–∞",
    "menu_topup": "üõí –î–æ–∫—É–ø–∏—Ç—å",
    "menu_profile": "üë§ –ü—Ä–æ—Ñ–∏–ª—å",
    "menu_help": "‚ÑπÔ∏è –ü–æ–º–æ—â—å",
    "menu_ref": "ü§ù –†–µ—Ñ–µ—Ä–∞–ª–∫–∞",
    "ask_study": "–ù–∞–ø–∏—à–∏ –≤–æ–ø—Ä–æ—Å –∏–ª–∏ –∑–∞–¥–∞–Ω–∏–µ. –Ø –æ—Ç–≤–µ—á—É –∫–∞–∫ —Ä–µ–ø–µ—Ç–∏—Ç–æ—Ä (–ø–æ—à–∞–≥–æ–≤–æ).",
    "ask_grade": "–û—Ç–ø—Ä–∞–≤—å —Å–≤–æ—ë —Ä–µ—à–µ–Ω–∏–µ (—Ç–µ–∫—Å—Ç –∏–ª–∏ —Ñ–æ—Ç–æ). –Ø –ø—Ä–æ–≤–µ—Ä—é –∫–∞–∫ —É—á–∏—Ç–µ–ª—å: –ø–æ—Å—Ç–∞–≤–ª—é –±–∞–ª–ª, –Ω–∞–π–¥—É –æ—à–∏–±–∫–∏ –∏ –¥–∞–º —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏.",
    "ask_ege": "–ù–∞–ø–∏—à–∏: —ç–∫–∑–∞–º–µ–Ω + –ø—Ä–µ–¥–º–µ—Ç + —Ç–µ–º–∞ (–ø—Ä–∏–º–µ—Ä: ¬´–ï–ì–≠ –º–∞—Ç–µ–º–∞—Ç–∏–∫–∞, –ø—Ä–æ–∏–∑–≤–æ–¥–Ω–∞—è¬ª). –î–∞–º —Ç–µ–æ—Ä–∏—é, —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É, –º–∏–Ω–∏-—Ç–µ—Å—Ç –∏ —Ä–∞–∑–±–æ—Ä.",
    "chill_menu": "–í—ã–±–µ—Ä–∏:",
        "chill_fact": "üòÑ –°–ª—É—á–∞–π–Ω—ã–π —Ñ–∞–∫—Ç",
    "chill_riddle": "üß† –ó–∞–≥–∞–¥–∫–∞",
    "chill_quiz": "‚ùì –í–∏–∫—Ç–æ—Ä–∏–Ω–∞",
    "chill_mental": "‚ûï –£—Å—Ç–Ω—ã–π —Å—á—ë—Ç",
    "chill_word": "üî§ –£–≥–∞–¥–∞–π —Å–ª–æ–≤–æ",
    "chill_show_answer": "üëÄ –ü–æ–∫–∞–∑–∞—Ç—å –æ—Ç–≤–µ—Ç",
    "menu_admin": "üõ† –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å",
    "history_filter_all": "–í—Å–µ",
    "history_filter_subjects": "–§–∏–ª—å—Ç—Ä –ø–æ –ø—Ä–µ–¥–º–µ—Ç—É:",
    "back": "‚¨ÖÔ∏è –ù–∞–∑–∞–¥",
    "need_sub_for_topup": "–î–æ–∫—É–ø–∏—Ç—å –º–æ–∂–Ω–æ –≤ –ª—é–±–æ–π –º–æ–º–µ–Ω—Ç ‚Äî –ø–∞–∫–µ—Ç—ã –¥–æ–±–∞–≤—è—Ç—Å—è —Å—Ä–∞–∑—É (–æ—Ç–≤–µ—Ç—ã/—Ñ–æ—Ç–æ-—Ä–∞–∑–±–æ—Ä—ã).",
    "limit_reached_text": "üö´ –õ–∏–º–∏—Ç –æ—Ç–≤–µ—Ç–æ–≤ –Ω–∞ —Å–µ–≥–æ–¥–Ω—è –∑–∞–∫–æ–Ω—á–∏–ª—Å—è.",
        "upsell": "‚≠ê –û—Ñ–æ—Ä–º–∏ PRO/ULTRA –∏–ª–∏ –¥–æ–∫—É–ø–∏ –ø–∞–∫–µ—Ç ‚Äî –∏ –ø—Ä–æ–¥–æ–ª–∂–∞–π —Å—Ä–∞–∑—É.",
    "profile": "üë§ –ü—Ä–æ—Ñ–∏–ª—å",
    "plan": "–¢–∞—Ä–∏—Ñ",
    "until": "–î–æ",
    "today": "–°–µ–≥–æ–¥–Ω—è",
    "left": "–û—Å—Ç–∞–ª–æ—Å—å",
    "ref_link": "üîó –¢–≤–æ—è —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å—Å—ã–ª–∫–∞",
    "ref_about": "30% —Å –ø–æ–∫—É–ø–æ–∫ –ø—Ä–∏–≥–ª–∞—à—ë–Ω–Ω—ã—Ö. –ù–∞–∫–æ–ø–∏ –º–∏–Ω–∏–º—É–º –∏ –∑–∞–ø—Ä–æ—Å–∏ –≤—ã–ø–ª–∞—Ç—É (/payout).",
    "ref_balance": "–†–µ—Ñ. –±–∞–ª–∞–Ω—Å",
    "payout_hint": "–ß—Ç–æ–±—ã –∑–∞–ø—Ä–æ—Å–∏—Ç—å –≤—ã–ø–ª–∞—Ç—É: /payout 300 (—Å—É–º–º–∞ –≤ Stars)",
    "payout_created": "‚úÖ –ó–∞—è–≤–∫–∞ –Ω–∞ –≤—ã–ø–ª–∞—Ç—É —Å–æ–∑–¥–∞–Ω–∞. –ê–¥–º–∏–Ω —Ä–∞—Å—Å–º–æ—Ç—Ä–∏—Ç –µ—ë.",
    "payout_too_small": "–°—É–º–º–∞ –º–µ–Ω—å—à–µ –º–∏–Ω–∏–º—É–º–∞.",
    "payout_not_enough": "–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤ –Ω–∞ —Ä–µ—Ñ. –±–∞–ª–∞–Ω—Å–µ.",
    "payout_cooldown": "–ó–∞—è–≤–∫—É –º–æ–∂–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –Ω–µ —á–∞—â–µ 1 —Ä–∞–∑–∞ –≤ —Å—É—Ç–∫–∏.",
    "payout_history": "–ò—Å—Ç–æ—Ä–∏—è –≤—ã–ø–ª–∞—Ç",
    "admin_payout_new": "üí∏ –ù–æ–≤–∞—è –∑–∞—è–≤–∫–∞ –Ω–∞ –≤—ã–ø–ª–∞—Ç—É",
    "admin_payout_paid": "‚úÖ –û—Ç–º–µ—á–µ–Ω–æ –∫–∞–∫ –≤—ã–ø–ª–∞—á–µ–Ω–æ.",
    "admin_payout_rejected": "‚ùå –û—Ç–∫–ª–æ–Ω–µ–Ω–æ.",
    "admin_payout_list": "üìã –ù–æ–≤—ã–µ –∑–∞—è–≤–∫–∏",
    "admin_reject_ask": "‚úçÔ∏è –ù–∞–ø–∏—à–∏ –ø—Ä–∏—á–∏–Ω—É –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è –æ–¥–Ω–∏–º —Å–æ–æ–±—â–µ–Ω–∏–µ–º (–∏–ª–∏ /skip).",
    "admin_reject_done": "‚úÖ –û—Ç–∫–ª–æ–Ω–µ–Ω–æ —Å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–º.",
    "user_payout_paid": "‚úÖ –¢–≤–æ—è –∑–∞—è–≤–∫–∞ –Ω–∞ –≤—ã–ø–ª–∞—Ç—É –æ–¥–æ–±—Ä–µ–Ω–∞ –∏ –æ—Ç–º–µ—á–µ–Ω–∞ –∫–∞–∫ –≤—ã–ø–ª–∞—á–µ–Ω–Ω–∞—è.",
    "user_payout_rejected": "‚ùå –¢–≤–æ—è –∑–∞—è–≤–∫–∞ –Ω–∞ –≤—ã–ø–ª–∞—Ç—É –æ—Ç–∫–ª–æ–Ω–µ–Ω–∞.",
    "revenue": "üí∞ –î–æ—Ö–æ–¥",
    "paid_ok": "‚úÖ –û–ø–ª–∞—Ç–∞ –ø–æ–ª—É—á–µ–Ω–∞! –ù–∞—á–∏—Å–ª–∏–ª.",
    "error_generic": "–£–ø—Å, —á—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫. –ü–æ–ø—Ä–æ–±—É–π –µ—â—ë —Ä–∞–∑.",
    "media_not_configured": "‚ö†Ô∏è –ú–µ–¥–∏–∞-–ø—Ä–æ–≤–∞–π–¥–µ—Ä –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω. –î–æ–±–∞–≤—å –∫–ª—é—á–∏/endpoint –≤ Railway Variables.",
    "help": "‚ÑπÔ∏è –ö–∞–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è:\n\nüìö –£—á—ë–±–∞: –ø–∏—à–∏ –∑–∞–¥–∞—á—É/–≤–æ–ø—Ä–æ—Å –∏–ª–∏ –ø—Ä–∏—à–ª–∏ —Ñ–æ—Ç–æ –î–ó ‚Äî —è —Ä–∞–∑–±–µ—Ä—É –∏ –ø–æ–º–æ–≥—É.\n‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏ –æ—Ü–µ–Ω–∫–∞: –ø—Ä–∏—à–ª–∏ —Å–≤–æ—ë —Ä–µ—à–µ–Ω–∏–µ (—Ç–µ–∫—Å—Ç/—Ñ–æ—Ç–æ) ‚Äî —è –ø–æ—Å—Ç–∞–≤–ª—é –±–∞–ª–ª –∏ —É–∫–∞–∂—É –æ—à–∏–±–∫–∏.\nüìù –û–ì–≠/–ï–ì–≠: –≤—ã–±–µ—Ä–∏ —ç–∫–∑–∞–º–µ–Ω –∏ –ø—Ä–µ–¥–º–µ—Ç, –¥–∞–ª—å—à–µ –∫–Ω–æ–ø–∫–∏ –ø–æ–º–æ–≥—É—Ç —É—á–∏—Ç—å—Å—è.\nüòÑ/üé≤ –û—Ç–≤–ª–µ—á—å—Å—è: —Ñ–∞–∫—Ç—ã –∏ –º–∏–Ω–∏-–∏–≥—Ä—ã.\n\n‚≠ê –ü–æ–¥–ø–∏—Å–∫–∞ –¥–∞—ë—Ç –±–æ–ª—å—à–∏–µ –ª–∏–º–∏—Ç—ã.\nüõí –î–æ–∫—É–ø–∏—Ç—å ‚Äî –µ—Å–ª–∏ –ª–∏–º–∏—Ç –∑–∞–∫–æ–Ω—á–∏–ª—Å—è.",
    "photo_limit_msg": "üì∏ –õ–∏–º–∏—Ç —Ñ–æ—Ç–æ-—Ä–∞–∑–±–æ—Ä–æ–≤ –Ω–∞ —Å–µ–≥–æ–¥–Ω—è –∑–∞–∫–æ–Ω—á–∏–ª—Å—è.\n\n–•–æ—á–µ—à—å –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å ‚Äî –º–æ–∂–Ω–æ –¥–æ–∫—É–ø–∏—Ç—å –ø–∞–∫–µ—Ç—ã —Ñ–æ—Ç–æ-—Ä–∞–∑–±–æ—Ä–æ–≤ –∏–ª–∏ –æ—Ñ–æ—Ä–º–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É.",
    "photo_trial_msg": "üéÅ –ü–µ—Ä–≤—ã–π —Ñ–æ—Ç–æ-—Ä–∞–∑–±–æ—Ä –≤ —Ä–µ–∂–∏–º–µ ¬´–ü—Ä–æ–≤–µ—Ä–∫–∞ –∏ –æ—Ü–µ–Ω–∫–∞¬ª –±—ã–ª –±–µ—Å–ø–ª–∞—Ç–Ω—ã–º.\n\n–ï—Å–ª–∏ —Ö–æ—á–µ—à—å –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å ‚Äî –¥–æ–∫—É–ø–∏ —Ñ–æ—Ç–æ-—Ä–∞–∑–±–æ—Ä—ã –∏–ª–∏ –æ—Ñ–æ—Ä–º–∏ –ø–æ–¥–ø–∏—Å–∫—É.",

  },
  "en": {
    "welcome_title": "üéì StudyAI ‚Äî study & creativity assistant",
    "welcome_body": "Pick a mode below.\\n\\nüí° Referral: Profile ‚Üí Referral.",
    "menu_study": "üìö Study help / Homework",
    "menu_ege": "üìù OGE / EGE",
    "menu_chill": "üé≤ Chill",
    "menu_sub": "‚≠ê Subscription",
    "menu_topup": "üõí Top up",
    "menu_profile": "üë§ Profile",
    "menu_help": "‚ÑπÔ∏è Help",
    "menu_ref": "ü§ù Referral",
    "ask_study": "Send your question/task. I‚Äôll answer like a tutor (step-by-step).",
    "ask_ege": "Tell me exam + subject + topic (e.g., ‚ÄúEGE math: derivatives‚Äù). I‚Äôll generate practice, mini-tests and step-by-step explanations.",
    "chill_menu": "Choose:",
        "chill_fact": "üòÑ Random fact",
    "chill_riddle": "üß† Riddle",
    "chill_quiz": "‚ùì Quiz",
    "chill_mental": "‚ûï Mental math",
    "chill_word": "üî§ Guess the word",
    "chill_show_answer": "üëÄ Show answer",
    "menu_admin": "üõ† Admin panel",
    "history_filter_all": "All",
    "history_filter_subjects": "Filter by subject:",
    "back": "‚¨ÖÔ∏è Back",
    "need_sub_for_topup": "Top-ups are available only with an active PRO/ULTRA subscription.",
    "limit_reached_text": "üö´ Daily answer limit reached.",
        "upsell": "‚≠ê Upgrade to PRO/ULTRA or buy a top-up to continue now.",
    "profile": "üë§ Profile",
    "plan": "Plan",
    "until": "Until",
    "today": "Today",
    "left": "Left",
    "ref_link": "üîó Your referral link",
    "ref_about": "30% from invitees' purchases. Reach minimum and request payout (/payout).",
    "ref_balance": "Referral balance",
    "payout_hint": "Request payout: /payout 300 (amount in Stars)",
    "payout_created": "‚úÖ Payout request created. Admin will review it.",
    "payout_too_small": "Amount is below minimum.",
    "payout_not_enough": "Not enough balance.",
    "payout_cooldown": "You can request payout once per day.",
    "payout_history": "Payout history",
    "admin_payout_new": "üí∏ New payout request",
    "admin_payout_paid": "‚úÖ Marked as paid.",
    "admin_payout_rejected": "‚ùå Rejected.",
    "admin_payout_list": "üìã New requests",
    "admin_reject_ask": "‚úçÔ∏è Send rejection reason in one message (or /skip).",
    "admin_reject_done": "‚úÖ Rejected with note.",
    "user_payout_paid": "‚úÖ Your payout request was approved and marked as paid.",
    "user_payout_rejected": "‚ùå Your payout request was rejected.",
    "revenue": "üí∞ Revenue",
    "paid_ok": "‚úÖ Payment received! Credited.",
    "error_generic": "Oops, something went wrong. Please try again.",
    "media_not_configured": "‚ö†Ô∏è Media provider is not configured. Add endpoint/keys in Railway Variables.",
    "help": "‚ÑπÔ∏è How to use:\n\nüìö Study: send a task/question or upload a homework photo ‚Äî I‚Äôll explain and help.\n‚úÖ Check & grade: send your solution (text/photo) ‚Äî I‚Äôll score it and show mistakes.\nüìù OGE/EGE: pick exam + subject, then use action buttons to study.\nüé≤ Chill: facts and mini-games.\n\n‚≠ê Subscription increases daily limits.\nüõí Top-ups add extra answers/photo checks instantly.",
 
    "photo_limit_msg": "üì∏ Your daily photo-check limit is over.\\n\\nTo continue, top up photo checks or subscribe.",
    "photo_trial_msg": "üéÅ Your first photo grading in ¬´Check & grade¬ª was free.\\n\\nTo continue, top up photo checks or subscribe.",

  }
}

def tr(lang: str, key: str) -> str:
    lang = lang if lang in T else "en"
    return T[lang].get(key, T["en"].get(key, key))
